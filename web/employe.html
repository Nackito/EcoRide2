<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EcoRide - Employé</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="p-4">
    <div class="container">
      <h1>Espace Employé</h1>

      <div class="row g-4">
        <div class="col-md-6">
          <div class="card card-body">
            <h5>Avis en attente</h5>
            <ul id="pendingAvis" class="list-group"></ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card card-body">
            <h5>Covoiturages avec incident</h5>
            <ul id="incidents" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>
    <script>
      const api = location.origin;
      const token = localStorage.getItem("token");
      if (!token) location = "index.html";

      async function fetchJSON(url, opts = {}) {
        const res = await fetch(url, {
          ...opts,
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
            ...(opts.headers || {}),
          },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Erreur");
        return data;
      }

      async function loadPending() {
        const list = document.getElementById("pendingAvis");
        list.innerHTML = "";
        const items = await fetchJSON(api + "/employee/avis/pending");
        items.forEach((it) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<div><strong>${it.auteur_pseudo || "-"}</strong> (${
            it.auteur_email
          })<br>${it.commentaire || ""} — note ${it.note || "-"}</div>`;
          const btns = document.createElement("div");
          const ok = document.createElement("button");
          ok.className = "btn btn-success btn-sm me-2";
          ok.textContent = "Valider";
          ok.onclick = async () => {
            await fetchJSON(api + "/employee/avis/" + it.id + "/validate", {
              method: "POST",
            });
            loadPending();
          };
          const ko = document.createElement("button");
          ko.className = "btn btn-outline-danger btn-sm";
          ko.textContent = "Refuser";
          ko.onclick = async () => {
            await fetchJSON(api + "/employee/avis/" + it.id + "/reject", {
              method: "POST",
            });
            loadPending();
          };
          btns.append(ok, ko);
          li.appendChild(btns);
          list.appendChild(li);
        });
      }

      async function loadIncidents() {
        const list = document.getElementById("incidents");
        list.innerHTML = "";
        const items = await fetchJSON(api + "/employee/covoiturages/incidents");
        items.forEach((c) => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = `#${c.id} ${c.date_depart} ${c.heure_depart} ${
            c.lieu_depart
          } -> ${c.lieu_arrivee} — statut: ${c.statut} — conducteur: ${
            c.driver_pseudo || "-"
          } (${c.driver_email || "-"})`;
          list.appendChild(li);
        });
      }

      loadPending();
      loadIncidents();
    </script>
  </body>
</html>
